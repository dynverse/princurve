---
output:
  github_document:
    html_preview: false
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup1, include=FALSE}
knitr::opts_chunk$set(fig.path = "man/figures/README_", warning = FALSE, message = FALSE, error = FALSE, echo = TRUE)
set.seed(1)
library(tidyverse)
```

# princurve
[![Build Status](https://travis-ci.org/dynverse/princurve.svg?branch=master)](https://travis-ci.org/dynverse/princurve)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/dynverse/princurve?branch=master&svg=true)](https://ci.appveyor.com/project/dynverse/princurve)
[![CRAN_Status_Badge](https://www.r-pkg.org/badges/version/princurve)](https://cran.r-project.org/package=princurve)
[![Coverage Status](https://codecov.io/gh/dynverse/princurve/branch/master/graph/badge.svg)](https://codecov.io/gh/dynverse/princurve?branch=master)

Fitting a principal curve to a data matrix in arbitrary dimensions.
A principal curve is a smooth curve passing through the middle of a multidimensional dataset. 
This package is an R/C++ reimplementation of the S/Fortran code provided by Trevor Hastie, 
with multiple performance tweaks.

Deriving a principal curve is an iterative process. This is what it looks like for 
a two-dimensional toy dataset:

```{r example, echo = FALSE, fig.width = 8, fig.height = 6}
library(princurve)
library(magick)

ggif_list <- function(list, .width = 8, .height = 6, .dpi = 80, .fps = 1, ...) {
  dir <- tempfile("gif_files")
  dir.create(dir)
  on.exit(unlink(dir))
  
  img <- lapply(
    seq_along(list),
    function(i) {
      filename <- paste0(dir, "/image-", i, ".png")
      ggsave(filename, list[[i]], width = .width, height = .height, dpi = .dpi)
      image_read(filename)
    }
  )
  
  image_animate(do.call(c, img), fps = .fps, dispose = "none")
}

ggif_lapply <- function(X, FUN, .width = 8, .height = 6, .dpi = 80, .fps = 1, ...) {
  list <- lapply(X, FUN)
  ggif_list(list, .width = .width, .height = .height, .dpi = .dpi, .fps = .fps, ...)
}

set.seed(1)
z <- sort(runif(100, -1.4 * pi, .4 * pi))
s <- data_frame(
  x = cos(z) * 1.5,
  y = sin(z)
)
x <- s %>% 
  sample_frac(1) %>% 
  mutate(
    x = x + rnorm(length(x), 0, .05),
    y = y + rnorm(length(x), 0, .05)
  )

ggif_lapply(seq(0, 10), function(it) {
  fit <- principal_curve(as.matrix(x), maxit = it)
  
  curve <- 
    as_data_frame(fit$s) %>% 
    mutate(lambda = fit$lambda, it = it) %>% 
    slice(fit$ord) %>% 
    mutate(pos = seq_len(n()))
  
  ggplot() +
    geom_point(aes(x, y), x, colour = "darkgray") +
    geom_path(aes(x, y), curve) +
    theme_bw() +
    coord_cartesian(xlim = c(-1.6, 1.6), ylim = c(-1.1, 1.1)) +
    labs(title = paste0("Iteration ", it)) 
})
```

For more information on how to use the `princurve` package, check out the following resources:
 
 * Vignette: [Introduction to the princurve package](https://cran.r-project.org/web/packages/princurve/vignettes/intro.html)
 * Help files: `?principal_curve`

## Latest changes
Check out `news(package = "princurve")` or [NEWS.md](inst/NEWS.md) for a full list of changes.

<!-- This section gets automatically generated from inst/NEWS.md, and also generates inst/NEWS -->

```{r news, results='asis', echo=FALSE}
news_md <- readr::read_lines("inst/NEWS.md")

# creating NEWS for package
news_normal <- news_md %>% 
  str_replace_all("^# princurve", "princurve") %>% 
  str_replace_all("\\[[^\\]]*\\]\\(([^\\)]*)\\)", "\\1")
readr::write_lines(news_normal, "inst/NEWS")

# creating text for readme
ix <- which(str_detect(news_md, "^# princurve"))

cat(str_replace(news_md[[ix[[1]]]], "^# ", "### Latest changes in "))

cat(news_md[seq(ix[[1]]+1, ix[[2]]-1)], sep = "\n")

cat(str_replace(news_md[[ix[[2]]]], "^# ", "### Latest changes in "))

cat(news_md[seq(ix[[2]]+1, ix[[3]]-1)], sep = "\n")
```

## References

Hastie, T. and Stuetzle, W., [Principal Curves](https://www.jstor.org/stable/2289936), JASA, Vol. 84, No. 406 (Jun., 1989), pp. 502-516, DOI: [10.2307/2289936](http://doi.org/10.2307/2289936) ([PDF](https://web.stanford.edu/~hastie/Papers/principalcurves.pdf))
